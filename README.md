[![Go Report Card](https://goreportcard.com/badge/github.com/camilamacedo86/audit)](https://goreportcard.com/report/github.com/camilamacedo86/audit)
[![Coverage Status](https://coveralls.io/repos/github/github.com/operator-framework/audit/badge.svg?branch=main)](https://coveralls.io/github/camilamacedo86/audit?branch=main)

---
# Audit

## Overview

The audit is an analytic tool which uses the Operator Framework solutions. Its purpose is to obtain and report and aggregate data provided by checks and analyses done in the operator bundles, packages and channels from an index catalog image.

Note that the latest version of the reports generated for all images can be checked in [testdata/report](testdata/reports). The file names are create by using the kind/type of the report, image name and date. (E.g. `testdata/report/bundles_quay.io_operatorhubio_catalog_latest_2021-04-22.xlsx`)

### Goals

- Be able to audit and gathering aspects all bundles, packages and channel of an OLM index catalog and output a report
- Be able to extract a report with the audit results and in some formats such as json. 
- Be able to perform validations and analyses in the index catalog for the bundle and catalog level.

For further information about its motivation see the [EP Audit command operation][audit-ep]. 

## Pre-requirements

- go 1.15+ < 1.16
- docker 
- access to the registry where the index catalog and operator bundle images are distribute
- access to a Kubernetes cluster
- [operator-sdk][operator-sdk] installed

NOTE that you can run the reports without SDK and the cluster running with by using the flag `--disable-scorecard`. That is only required for the scorecard results.  

## Install

To get the project and install the binary:

```sh
$ git clone git@github.com:camilamacedo86/audit.git
$ cd audit
$ make install
```

## Usage

You need first use docker login to have access to the images. Following the example for the OCP downstream catalog to audit the image `registry.redhat.io/redhat/certified-operator-index:v4.7`

```sh
docker login https://registry.connect.redhat.com
docker login https://registry.redhat.io
```

Now, you can audit all operator bundles of an image catalog with: 

```sh 
./bin/audit bundles --index-image=registry.redhat.io/redhat/redhat--operator-index:v4.7 --head-only --output-path=testdata/xls
```

Now, you can audit all packages of an image catalog with: 

```sh 
./bin/audit packages --index-image=registry.redhat.io/redhat/redhat--operator-index:v4.7 --output-path=testdata/xls
```

Note that you can also output the results in JSON format:

```sh 
./bin/audit bundles index \
    --index-image=registry.redhat.io/redhat/redhat-operator-index:v4.7 \
    --limit=3 \
    --head-only \
    --output=json \  
    --output-path=testdata/json
```

NOTE: Use the `--help` flag to check the options and the further information about its commands.

## Reports

| Report Type | Command | Description |
| ------ | ----- |  ------ |
| bundles | `audit bundle --index-image [OPTIONS]` | Audit all Bundles |
| packages | `audit packages --index-image [OPTIONS]` | Audit all Packages |
| channels | `audit channels --index-image [OPTIONS]` | Audit all Channels |

## Testdata

The samples in `testdata/samples` which are generated by running `make generate-samples`. Also, to run a full report for all images in `testdata/reports` run `make full-report`.

## FAQ

### How Audit works?

Following the steps performed by Audit. 

- Extract the database from the image informed
- Perform SQL queries to obtain the data from the index db
- Download and extract all bundles files by using the operator bundle path which is stored in the index db  
- Get the required data for the report from the operator bundle manifest files 
- Use the [operator-framework/api][of-api] to execute the bundle validator checks
- Use SDK tool to execute the Scorecard bundle checks
- Output a report providing the information obtained and processed. 

For some detailed information about its implementation check [here](docs/steps.md).

### What means UNKNOWN ?

If is not possible gathering the information, for example, when the Operator Bundle Path info is not in the index db then, audit will set the data as `UNKNOWN`. 

### What means NOT USED ?

If you see a column with this information than that means that the specific criteria is not useful or applied to none operator bundle of a package or the specific bundle itself.

### What are the images used to generate the full reports?

- OCP images: See [Understanding Operator catalogs](https://github.com/openshift/openshift-docs/blob/master/modules/olm-understanding-operator-catalog-images.adoc#understanding-operator-catalogs)
- Community operator image (`quay.io/operatorhubio/catalog:latest`): Its source is from [upstream-community-operators](https://github.com/operator-framework/community-operators/tree/master/upstream-community-operators)

### What are the reports in the testdata/reports/backport? 

These reports were generated for we are able to identify the projects which are using the index image label `com.redhat.delivery.backport=true`.Â 

[of-api]: https://github.com/operator-framework/api
[scorecard-config]: https://github.com/operator-framework/operator-sdk/blob/v1.5.0/testdata/go/v3/memcached-operator/bundle/tests/scorecard/config.yaml
[operator-sdk]: https://github.com/operator-framework/operator-sdk
[audit-ep]: https://github.com/operator-framework/enhancements/blob/master/enhancements/audit-command.md